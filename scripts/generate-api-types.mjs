import { existsSync } from 'node:fs';
import { readFile, writeFile } from 'node:fs/promises';
import path from 'node:path';
import openapiTS, { astToString } from 'openapi-typescript';
import prettier from 'prettier';

const localSpecPath = path.resolve(process.cwd(), '../barforge-registry-api/docs/openapi.yaml');
const remoteSpecUrl =
	'https://raw.githubusercontent.com/jtaw5649/barforge-registry-api/master/docs/openapi.yaml';

const input =
	process.env.OPENAPI_SPEC_PATH || (existsSync(localSpecPath) ? localSpecPath : remoteSpecUrl);

async function loadSpec(source) {
	if (source.startsWith('http://') || source.startsWith('https://')) {
		const response = await fetch(source);
		if (!response.ok) {
			throw new Error(`Failed to fetch OpenAPI spec: ${response.status}`);
		}
		return response.text();
	}
	return readFile(source, 'utf8');
}

const spec = await loadSpec(input);
const ast = await openapiTS(spec, {
	commentHeader: 'Generated by scripts/generate-api-types.mjs. Do not edit.'
});
const header = '// Generated by scripts/generate-api-types.mjs. Do not edit.';
const dts = `${header}\n\n${astToString(ast)}`;

const outputPath = path.resolve(process.cwd(), 'src/lib/api-types.ts');
const prettierConfig = (await prettier.resolveConfig(outputPath)) ?? {};
const formatted = await prettier.format(dts, {
	...prettierConfig,
	parser: 'typescript'
});
await writeFile(outputPath, formatted);
console.log(`API types written to ${outputPath}`);
